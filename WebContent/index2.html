<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>模型</title>
	<base href="./">	
    <script src="public/js/scenejs/plugins/lib/jquery-1.8.3.min.js"></script>
	<script src="public/js/scenejs/scenejs.js"></script>
	<script src="public/js/scenejs/plugins/node/geometry/base64util.js"></script>
	<script src="public/js/bimsuferapi/BIMSURFER.js"></script>
	<script src="public/js/bimsuferapi/SceneJS.js"></script>
	<script src="public/js/ifc/Constants.js"></script>
	<script src="public/js/bimsuferapi/ProgressLoader.js"></script>
	<script src="public/js/bimsuferapi/Types/Light.js"></script>
	<script src="public/js/bimsuferapi/Types/Light/Ambient.js"></script>
	<script src="public/js/bimsuferapi/Types/Light/Sun.js"></script>
	<script src="public/js/bimsuferapi/Control.js"></script>
	<script src="public/js/bimsuferapi/Control/ClickSelect.js"></script>
	<script src="public/js/bimsuferapi/Control/LayerList.js"></script>
	<script src="public/js/bimsuferapi/Control/ProgressBar.js"></script>
	<script src="public/js/bimsuferapi/Control/PickFlyOrbit.js"></script>
	<script src="public/js/bimsuferapi/Control/ObjectTreeView.js"></script>
	<script src="public/js/bimsuferapi/Events.js"></script>
	<script src="public/js/bimsuferapi/StringView.js"></script>
	<script src="public/js/bimsuferapi/AsyncStream.js"></script>
	<script src="public/js/bimsuferapi/DataInputStream.js"></script>
	<script src="public/js/bimsuferapi/Viewer.js"></script>
	<script src="public/js/bimsuferapi/Util.js"></script>
</head>
<body>

    <script>
    var scene = {};
    
    SceneJS.setConfigs({
        pluginPath:"public/js/scenejs/plugins"
    });
    
    queryData();
    
	function queryData() {
	    var params = {rid:3};
	    
	    $.ajax ({
	        async:false,
	        type: "GET",
	        url: "queryDbGeometryInfo.do",
	        data: params,
	       	dataType:"json",
	        success:function(data) {
	        	console.log(data);
	//        	var str = JSON.stringify(data);
	        	showView(data);
	        },
	        error:function(data){
	            alert("error");
	        }	        	        
	    });
	}



	function showView(data) {
		var geometries = data.geometries;
		var boundMinX = 0, boundMinY = 0, boundMinZ = 0, boundMaxX = 0, boundMaxY = 0, boundMaxZ = 0;
	}
	
	var BimRender = {
		start:function(data){
			var geometries = data.geometries;
			for(var i = 0; i < geometries.length; i++){
				var geom = geometries[i];
				var center = {
					x: (geom.bound.max.x + geom.bound.min.x) / 2,
					y: (geom.bound.max.y + geom.bound.min.y) / 2,
					z: (geom.bound.max.z + geom.bound.min.z) / 2
				};
			}
			o.boundsTranslate = o.viewer.scene.findNode("bounds_translate");
			var firstModel = false;
			if (o.boundsTranslate == null) {
				var firstModel = true;
				o.boundsTranslate = {
					id: "bounds_translate",
					type: "translate",
					x: -center.x,
					y: -center.y,
					z: -center.z,
					nodes: []
				};
				o.boundsTranslate = o.viewer.scene.findNode("my-lights").addNode(o.boundsTranslate);
			}

			o.modelNode = o.viewer.scene.findNode("model_node_" + o.groupId);
			if (o.modelNode == null) {
				o.modelNode = {
					id: "model_node_" + o.groupId,
					type: "translate",
					x: 0,
					y: 0,
					z: 0,
					data: {
						groupId: o.groupId
					},
					nodes: []
				};
				o.modelNode = o.boundsTranslate.addNode(o.modelNode);
			}

			if (firstModel) {
				var lookat = o.viewer.scene.findNode("main-lookAt");
				var eye = { x: (modelBounds.max.x - modelBounds.min.x) * 0.5, y: (modelBounds.max.y - modelBounds.min.y) * -1, z: (modelBounds.max.z - modelBounds.min.z) * 0.5 };
				lookat.set("eye", eye);

				var maincamera = o.viewer.scene.findNode("main-camera");

				var diagonal = Math.sqrt(Math.pow(modelBounds.max.x - modelBounds.min.x, 2) + Math.pow(modelBounds.max.y - modelBounds.min.y, 2) + Math.pow(modelBounds.max.z - modelBounds.min.z, 2));

				var far = diagonal * 5; // 5 being a guessed constant that should somehow coincide with the max zoom-out-factor

				maincamera.setOptics({
					type: 'perspective',
					far: far,
					near: far / 1000,
					aspect: jQuery(o.viewer.canvas).width() / jQuery(o.viewer.canvas).height(),
					fovy: 37.8493
				});
			}
		}


	}



    </script>
</body>
</html>